rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is in a list of IDs
    function isMember(memberIds) {
      return isAuthenticated() && request.auth.uid in memberIds;
    }
    
    // Check if user is in participants array
    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }
    
    // Validate string length
    function validStringLength(str, minLen, maxLen) {
      return str.size() >= minLen && str.size() <= maxLen;
    }
    
    // Validate array size
    function validArraySize(arr, minSize, maxSize) {
      return arr.size() >= minSize && arr.size() <= maxSize;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone authenticated can read any user profile (for search, chat participants, etc.)
      // Requirement 3.3, 3.4: Allow all authenticated users to read profiles
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      // Requirement 3.1: Allow users to create their own profile
      // Requirement 3.2: Deny creation of profiles for other users (enforced by userId check)
      // Accept both 'uid' and 'userId' field names for backward compatibility
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && (request.resource.data.uid == userId || request.resource.data.userId == userId)
        && request.resource.data.email is string
        && request.resource.data.displayName is string
        && request.resource.data.displayName.size() <= 100;
      
      // Users can update their own profile only
      // Requirement 3.5: Prevent users from updating other users' profiles
      // Accept both 'uid' and 'userId' field names for backward compatibility
      allow update: if isOwner(userId)
        && (!('email' in request.resource.data.diff(resource.data).affectedKeys()) 
            || request.resource.data.email == resource.data.email);
      
      // Allow users to delete their own profile (for account deletion)
      // Requirement 7.6: Support account deletion for Play Store compliance
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // GROUPS COLLECTION
    // ============================================
    match /groups/{groupId} {
      // Members can read their groups, or anyone can read public groups
      allow read: if isAuthenticated() 
        && (request.auth.uid in resource.data.memberIds 
            || resource.data.get('settings', {}).get('isPublic', false) == true);
      
      // TEMPORARY: Allow any authenticated user to create groups (for debugging)
      // TODO: Add back security checks once issue is resolved
      allow create: if isAuthenticated();
      
      // Members can update group (for joining, leaving, updating tasks)
      allow update: if isAuthenticated()
        && (request.auth.uid in resource.data.memberIds
            || (resource.data.get('settings', {}).get('isPublic', false) == true 
                && request.auth.uid in request.resource.data.memberIds))
        && validArraySize(request.resource.data.memberIds, 1, 100)
        && (resource.data.owner == request.resource.data.owner);
      
      // Only owner can delete (soft delete by setting isActive = false)
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.owner;
    }
    
    // ============================================
    // TASKS COLLECTION
    // ============================================
    match /tasks/{taskId} {
      // Users can read tasks they created or are assigned to
      allow read: if isAuthenticated() 
        && (request.auth.uid == resource.data.userId 
            || request.auth.uid in resource.data.get('assignedTo', []));
      
      // Users can create their own tasks
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && validStringLength(request.resource.data.title, 1, 200)
        && validStringLength(request.resource.data.description, 0, 1000)
        && request.resource.data.status in ['pending', 'in_progress', 'completed', 'overdue']
        && request.resource.data.priority in ['low', 'medium', 'high']
        && request.resource.data.category in ['personal', 'group', 'assignment']
        && validArraySize(request.resource.data.get('assignedTo', []), 0, 50);
      
      // Task creator or assigned users can update
      allow update: if isAuthenticated()
        && (request.auth.uid == resource.data.userId 
            || request.auth.uid in resource.data.get('assignedTo', []))
        && request.resource.data.userId == resource.data.userId
        && validStringLength(request.resource.data.title, 1, 200)
        && validArraySize(request.resource.data.get('assignedTo', []), 0, 50);
      
      // Only task creator can delete
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // MESSAGES COLLECTION (Top-level for account deletion)
    // ============================================
    match /messages/{messageId} {
      // Users can read messages they sent
      allow read: if isAuthenticated() 
        && request.auth.uid == resource.data.senderId;
      
      // Users can create messages
      allow create: if isAuthenticated()
        && request.resource.data.senderId == request.auth.uid;
      
      // Users can update their own messages
      allow update: if isAuthenticated()
        && request.auth.uid == resource.data.senderId;
      
      // Users can delete their own messages (for account deletion)
      // Requirement 7.6: Support account deletion for Play Store compliance
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.senderId;
    }
    
    // ============================================
    // GROUP MEMBERS COLLECTION (for account deletion)
    // ============================================
    match /groupMembers/{memberId} {
      // Users can read their own memberships
      allow read: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can create their own memberships
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own memberships
      allow update: if isAuthenticated()
        && request.auth.uid == resource.data.userId;
      
      // Users can delete their own memberships (for account deletion)
      // Requirement 7.6: Support account deletion for Play Store compliance
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // CHATS COLLECTION
    // ============================================
    match /chats/{chatId} {
      // Participants can read their chats, or group members can read group chats
      allow read: if isAuthenticated() 
        && (request.auth.uid in resource.data.participants
            || (resource.data.type == 'GROUP' 
                && request.auth.uid in get(/databases/$(database)/documents/groups/$(resource.data.groupId)).data.memberIds));
      
      // Users can create chats if they're a participant or creating a group chat for their group
      allow create: if isAuthenticated()
        && request.auth.uid in request.resource.data.participants
        && validArraySize(request.resource.data.participants, 1, 100)
        && (request.resource.data.type == 'DIRECT' 
            ? request.resource.data.participants.size() == 2
            : request.resource.data.participants.size() >= 1);
      
      // Participants can update chat metadata
      allow update: if isAuthenticated()
        && (request.auth.uid in resource.data.participants
            || (resource.data.type == 'GROUP' 
                && request.auth.uid in get(/databases/$(database)/documents/groups/$(resource.data.groupId)).data.memberIds));
      
      // Participants can delete chats
      allow delete: if isAuthenticated() 
        && request.auth.uid in resource.data.participants;
      
      // ============================================
      // MESSAGES SUBCOLLECTION
      // ============================================
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Participants can create messages
        allow create: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.chatId == chatId
          && validStringLength(request.resource.data.get('text', ''), 0, 5000)
          && request.resource.data.status in ['SENDING', 'SENT', 'DELIVERED', 'READ', 'FAILED', 'FAILED_RETRYABLE', 'FAILED_PERMANENT'];
        
        // Participants can update messages (sender to edit, recipients to mark as read)
        allow update: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && request.resource.data.senderId == resource.data.senderId
          && request.resource.data.chatId == resource.data.chatId;
        
        // Message sender can delete their own messages
        allow delete: if isAuthenticated() 
          && request.auth.uid == resource.data.senderId;
      }
      
      // ============================================
      // TYPING STATUS SUBCOLLECTION
      // ============================================
      match /typing_status/{userId} {
        // Participants can read typing status
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Users can write their own typing status
        allow write: if isAuthenticated()
          && request.auth.uid == userId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Any authenticated user can create notifications (for triggering push notifications)
      allow create: if isAuthenticated();
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // GROUP ACTIVITIES COLLECTION
    // ============================================
    match /group_activities/{activityId} {
      // Anyone authenticated can read activities (for feed)
      allow read: if isAuthenticated();
      
      // Authenticated users can create activities
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && validStringLength(request.resource.data.title, 1, 200)
        && validStringLength(request.resource.data.description, 0, 500)
        && request.resource.data.type in ['message', 'assignment', 'member_joined', 'member_left', 'task_created', 'task_completed', 'group_created'];
      
      // Activity creator can update
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Activity creator can delete
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // SESSIONS COLLECTION (for monitoring)
    // ============================================
    match /sessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can create their own sessions
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own sessions
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can delete their own sessions
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
  }
}