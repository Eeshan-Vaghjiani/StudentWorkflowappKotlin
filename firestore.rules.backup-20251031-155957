rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is in a list of IDs
    function isMember(memberIds) {
      return isAuthenticated() && request.auth.uid in memberIds;
    }
    
    // Check if user is in participants array
    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }
    
    // Validate string length
    function validStringLength(str, minLen, maxLen) {
      return str.size() >= minLen && str.size() <= maxLen;
    }
    
    // Validate array size
    function validArraySize(arr, minSize, maxSize) {
      return arr.size() >= minSize && arr.size() <= maxSize;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone authenticated can read any user profile (for search, chat participants, etc.)
      // Requirement 3.3, 3.4: Allow all authenticated users to read profiles
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      // Requirement 3.1: Allow users to create their own profile
      // Requirement 3.2: Deny creation of profiles for other users (enforced by userId check)
      // Accept both 'uid' and 'userId' field names for backward compatibility
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && (request.resource.data.uid == userId || request.resource.data.userId == userId)
        && request.resource.data.email is string
        && validStringLength(request.resource.data.displayName, 1, 100);
      
      // Users can update their own profile only
      // Requirement 3.5: Prevent users from updating other users' profiles
      // Accept both 'uid' and 'userId' field names for backward compatibility
      allow update: if isOwner(userId)
        && (request.resource.data.uid == userId || request.resource.data.userId == userId)
        && (!('email' in request.resource.data.diff(resource.data).affectedKeys()) 
            || request.resource.data.email == resource.data.email);
      
      // Prevent deletion of user profiles
      // Requirement 3.5: Prevent profile deletion to maintain data integrity
      allow delete: if false;
    }
    
    // ============================================
    // GROUPS COLLECTION
    // ============================================
    match /groups/{groupId} {
      // Members can read their groups
      allow read: if isAuthenticated() 
        && (request.auth.uid in resource.data.memberIds 
            || resource.data.get('settings', {}).get('isPublic', false) == true);
      
      // Any authenticated user can create a group
      allow create: if isAuthenticated()
        && request.resource.data.owner == request.auth.uid
        && request.auth.uid in request.resource.data.memberIds
        && validStringLength(request.resource.data.name, 1, 100)
        && validStringLength(request.resource.data.description, 0, 500)
        && validStringLength(request.resource.data.joinCode, 6, 6)
        && validArraySize(request.resource.data.memberIds, 1, 100)
        && request.resource.data.memberIds.hasOnly([request.auth.uid])
        && request.resource.data.isActive == true;
      
      // Members can update group (for joining, leaving, updating tasks)
      allow update: if isAuthenticated()
        && (request.auth.uid in resource.data.memberIds
            || (resource.data.get('settings', {}).get('isPublic', false) == true 
                && request.auth.uid in request.resource.data.memberIds))
        && validArraySize(request.resource.data.memberIds, 1, 100)
        && (resource.data.owner == request.resource.data.owner);
      
      // Only owner can delete (soft delete by setting isActive = false)
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.owner;
    }
    
    // ============================================
    // TASKS COLLECTION
    // ============================================
    match /tasks/{taskId} {
      // Users can read tasks they created or are assigned to
      allow read: if isAuthenticated() 
        && (request.auth.uid == resource.data.userId 
            || request.auth.uid in resource.data.get('assignedTo', []));
      
      // Users can create their own tasks
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && validStringLength(request.resource.data.title, 1, 200)
        && validStringLength(request.resource.data.description, 0, 1000)
        && request.resource.data.status in ['pending', 'in_progress', 'completed', 'overdue']
        && request.resource.data.priority in ['low', 'medium', 'high']
        && request.resource.data.category in ['personal', 'group', 'assignment']
        && validArraySize(request.resource.data.get('assignedTo', []), 0, 50);
      
      // Task creator or assigned users can update
      allow update: if isAuthenticated()
        && (request.auth.uid == resource.data.userId 
            || request.auth.uid in resource.data.get('assignedTo', []))
        && request.resource.data.userId == resource.data.userId
        && validStringLength(request.resource.data.title, 1, 200)
        && validArraySize(request.resource.data.get('assignedTo', []), 0, 50);
      
      // Only task creator can delete
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // CHATS COLLECTION
    // ============================================
    match /chats/{chatId} {
      // Participants can read their chats
      allow read: if isAuthenticated() 
        && request.auth.uid in resource.data.participants;
      
      // Users can create chats if they're a participant
      allow create: if isAuthenticated()
        && request.auth.uid in request.resource.data.participants
        && validArraySize(request.resource.data.participants, 2, 100)
        && request.resource.data.participants.hasAll([request.auth.uid])
        && (request.resource.data.type == 'DIRECT' 
            ? request.resource.data.participants.size() == 2
            : request.resource.data.participants.size() >= 2);
      
      // Participants can update chat metadata
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.participants
        && request.resource.data.participants == resource.data.participants;
      
      // Participants can delete chats
      allow delete: if isAuthenticated() 
        && request.auth.uid in resource.data.participants;
      
      // ============================================
      // MESSAGES SUBCOLLECTION
      // ============================================
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Participants can create messages
        allow create: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.chatId == chatId
          && validStringLength(request.resource.data.get('text', ''), 0, 5000)
          && request.resource.data.status in ['SENDING', 'SENT', 'DELIVERED', 'READ', 'FAILED', 'FAILED_RETRYABLE', 'FAILED_PERMANENT'];
        
        // Message sender can update their own messages
        allow update: if isAuthenticated()
          && request.resource.data.senderId == resource.data.senderId
          && request.auth.uid == resource.data.senderId;
        
        // Message sender can delete their own messages
        allow delete: if isAuthenticated() 
          && request.auth.uid == resource.data.senderId;
      }
      
      // ============================================
      // TYPING STATUS SUBCOLLECTION
      // ============================================
      match /typing_status/{userId} {
        // Participants can read typing status
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Users can write their own typing status
        allow write: if isAuthenticated()
          && request.auth.uid == userId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // System or users can create notifications for others
      allow create: if isAuthenticated()
        && validStringLength(request.resource.data.title, 1, 200)
        && validStringLength(request.resource.data.message, 1, 500)
        && request.resource.data.type in ['TASK_ASSIGNED', 'TASK_COMPLETED', 'TASK_DUE_SOON', 'GROUP_INVITE', 'GROUP_JOINED', 'NEW_MESSAGE', 'MENTION', 'SYSTEM'];
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // GROUP ACTIVITIES COLLECTION
    // ============================================
    match /group_activities/{activityId} {
      // Anyone authenticated can read activities (for feed)
      allow read: if isAuthenticated();
      
      // Authenticated users can create activities
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && validStringLength(request.resource.data.title, 1, 200)
        && validStringLength(request.resource.data.description, 0, 500)
        && request.resource.data.type in ['message', 'assignment', 'member_joined', 'member_left', 'task_created', 'task_completed', 'group_created'];
      
      // Activity creator can update
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Activity creator can delete
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // SESSIONS COLLECTION (for monitoring)
    // ============================================
    match /sessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can create their own sessions
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own sessions
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can delete their own sessions
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }
  }
}
